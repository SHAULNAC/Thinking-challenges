<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0337BRSKEV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0337BRSKEV');
    </script>

    <meta charset="UTF-8">
    <title>××¨×•×¥ ×”××›×œ×•×œ - ×”××ª×’×¨ ×”×™×•××™</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --glass: rgba(255, 255, 255, 0.95);
            --primary: #0f172a; 
            --accent: #3b82f6; 
            --success: #10b981;
            --danger: #ef4444;
            --gold: #f59e0b;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Assistant', sans-serif; 
            margin: 0; 
            background: radial-gradient(circle at top right, #1e293b, #0f172a); 
            color: #f8fafc; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: inherit; z-index: 1000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;
        }

        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem; border-radius: 24px; width: 100%; max-width: 500px;
            text-align: center; box-shadow: var(--shadow);
        }

        h1 { font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -1px; }
        .subtitle { color: #94a3b8; margin-bottom: 2rem; }

        .btn {
            background: var(--accent); color: white; border: none; padding: 12px 24px;
            border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            width: 100%; margin: 8px 0; font-size: 1rem;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-gold { background: var(--gold); }
        .btn-outline { background: transparent; border: 2px solid rgba(255,255,255,0.1); }

        #game-ui { display: grid; grid-template-columns: 300px 1fr; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        #sidebar { position: sticky; top: 20px; height: fit-content; }
        
        #content-area { 
            background: var(--glass); color: #334155; padding: 40px; border-radius: 24px;
            box-shadow: var(--shadow); line-height: 1.7; font-size: 1.1rem;
        }

        #content-area a { color: var(--accent); text-decoration: none; font-weight: 600; border-bottom: 1px solid transparent; }
        #content-area a:hover { border-bottom-color: var(--accent); }

        #vertical-tracker {
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 200px; background: rgba(255,255,255,0.1);
            border-radius: 10px; display: none;
        }
        #vertical-tracker.active { display: block; }
        #distance-tag {
            position: absolute; right: 25px; top: 0; white-space: nowrap;
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 800;
        }

        #win-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="start-screen">
    <div class="card">
        <h1>××¨×•×¥ ×”××›×œ×•×œ ğŸ</h1>
        <p class="subtitle">×”×’×¢ ××¢×¨×š ××—×“ ×œ×©× ×™ ×‘××™× ×™××•× ×¦×¢×“×™×</p>
        
        <div id="best-scores" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; flex: 1;">
                <small style="color: #94a3b8;">×©×™× ×¦×¢×“×™×</small><br>
                <strong id="best-steps">---</strong>
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; flex: 1;">
                <small style="color: #94a3b8;">×©×™× ×–××Ÿ</small><br>
                <strong id="best-time">---</strong>
            </div>
        </div>

        <div id="yesterday-path-container" style="display:none; margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); text-align: right;">
            <span style="font-size: 0.8em; color: #94a3b8; display: block; margin-bottom: 5px;">ğŸ† ×”××¡×œ×•×œ ×”×§×¦×¨ ×‘×™×•×ª×¨ ×××ª××•×œ:</span>
            <div id="yesterday-path-text" style="font-size: 0.9em; color: var(--gold); line-height: 1.4; word-break: break-word;"></div>
        </div>

        <button class="btn btn-gold" onclick="startDailyChallenge()">ğŸ“… ×”××ª×’×¨ ×”×™×•××™</button>
        <button class="btn btn-outline" onclick="startExtreme(40)">ğŸ² ××ª×’×¨ ××§×¨××™</button>
        
        <div id="status-message" style="margin-top: 15px; font-size: 0.9em; color: var(--gold);"></div>
    </div>
</div>

<div id="game-ui">
    <div id="sidebar">
        <div class="card" style="text-align: right; padding: 1.5rem;">
            <div style="font-size: 0.8rem; color: #94a3b8;">×”×™×¢×“ ×©×œ×š:</div>
            <div id="target-label" style="font-size: 1.5rem; font-weight: 800; color: var(--gold);">---</div>
            <hr style="opacity: 0.1; margin: 15px 0;">
            <div style="display: flex; justify-content: space-between;">
                <span>×¦×¢×“×™×: <strong id="click-count">0</strong></span>
                <span>×–××Ÿ: <strong id="timer">00:00</strong></span>
            </div>
            <button class="btn btn-outline" style="margin-top: 15px;" onclick="goBack()">ğŸ”™ ×—×–×•×¨ ××—×•×¨×”</button>
            <button class="btn btn-outline" onclick="useHint()">ğŸ’¡ ×¨××– (<span id="hints-left">3</span>)</button>
        </div>
    </div>
    <div id="content-area"></div>
</div>

<div id="vertical-tracker">
    <div id="distance-tag">××ª×§×¨×‘...</div>
</div>

<div id="win-screen">
    <div class="card">
        <h1 style="color: var(--gold);">× ×™×¦×—×•×Ÿ! ğŸ†</h1>
        <p id="win-summary"></p>
        <div id="final-path" style="text-align: right; max-height: 200px; overflow-y: auto; margin: 20px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;"></div>
        <button class="btn" onclick="shareResults()">×©×™×ª×•×£ ×ª×•×¦××” ğŸš€</button>
        <button class="btn btn-outline" onclick="location.reload()">××©×—×§ ×—×“×©</button>
    </div>
</div>

<script>
    // ×›××Ÿ × ×›× ×¡ ×›×œ ×§×•×“ ×”-JavaScript ×©×¡×™×¤×§×ª×™ ×œ×š ×‘×ª×©×•×‘×” ×”×§×•×“××ª
    let clicks = 0, seconds = 0, timerInterval, targetTitle = "", historyStack = [], dist1Nodes = new Set(), hintsLeft = 3;
    let isDailyChallenge = false;
    let stats = JSON.parse(localStorage.getItem('hamichlol_pro_stats')) || { totalWins: 0, totalClicks: 0, totalTime: 0 };
    let playerName = localStorage.getItem('hamichlol_player_name') || "";

    // ×›×ª×•×‘×ª ×”-WebApp ×©×œ×š
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwBgde_9uh2ykFsR_6bzGpVFkofv22mV-g1cDBfHRWePOmhCqLsi5Tdl_Gon04WFxaq/exec";

    // --- ×”×¤×•× ×§×¦×™×•×ª ×”××¨×›×–×™×•×ª ---
    async function fetchLeaderboard() {
        try {
            const response = await fetch(`${WEB_APP_URL}?action=getBestScores&t=${Date.now()}`);
            const data = await response.json();
            if (data && data.status === "success") {
                document.getElementById('best-steps').innerText = data.minSteps || "---";
                document.getElementById('best-time').innerText = data.minTime || "---";
                const pathContainer = document.getElementById('yesterday-path-container');
                const pathText = document.getElementById('yesterday-path-text');
                if (data.yesterdayPath && data.yesterdayPath !== "××™×Ÿ × ×ª×•× ×™× ×××ª××•×œ") {
                    pathText.innerText = data.yesterdayPath;
                    pathContainer.style.display = 'block';
                } else {
                    pathContainer.style.display = 'none';
                }
            }
        } catch (e) { }
    }

    async function startDailyChallenge() {
        if (!playerName) {
            playerName = prompt("×”×–×Ÿ ×©× ××©×ª××© ×œ××ª×’×¨:");
            if (!playerName) return;
            localStorage.setItem('hamichlol_player_name', playerName);
        }
        const todayStr = new Date().toLocaleDateString('en-GB');
        document.getElementById('status-message').innerText = "×‘×•×“×§ ×”×¨×©××•×ª ×›× ×™×¡×”...";
        try {
            const checkRes = await fetch(`${WEB_APP_URL}?action=checkIfPlayed&name=${encodeURIComponent(playerName)}&date=${todayStr}`);
            const checkData = await checkRes.json();
            if (checkData.played) {
                alert("×›×‘×¨ ×©×™×—×§×ª ×”×™×•× ×‘××ª×’×¨ ×”×™×•××™!");
                document.getElementById('status-message').innerText = "";
                return;
            }
        } catch (e) { }

        document.getElementById('status-message').innerText = "×˜×•×¢×Ÿ ××ª×’×¨...";
        try {
            const response = await fetch(`${WEB_APP_URL}?action=getDaily&date=${todayStr}`);
            const data = await response.json();
            if (data && data.found) {
                isDailyChallenge = true;
                setupGame(data.start, data.target);
            } else {
                // ×œ×•×’×™×§×” ×œ×™×¦×™×¨×ª ××ª×’×¨ ×—×“×© ×× ××™×Ÿ
                document.getElementById('status-message').innerText = "××’×¨×™×œ ×™×¢×“...";
                const start = await getRandomArticle();
                const target = await getRandomArticle(); // ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×ª ××™××•×ª ×§×©×¨
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: "saveDaily", date: todayStr, start: start, target: target })
                });
                isDailyChallenge = true;
                setupGame(start, target);
            }
        } catch (e) { }
    }

    async function loadArticle(title, isBack = false) {
        const area = document.getElementById('content-area');
        try {
            const res = await fetch(`https://www.hamichlol.org.il/w/api.php?action=parse&page=${encodeURIComponent(title)}&format=json&origin=*&prop=text|displaytitle|links&redirects=1`);
            const data = await res.json();
            if (data.parse) {
                const current = data.parse.displaytitle.replace(/<[^>]*>?/gm, '');
                area.innerHTML = `<h1>${current}</h1>` + data.parse.text["*"];
                if (!isBack) historyStack.push(current);
                if (current.toLowerCase() === targetTitle.toLowerCase()) win();
                window.scrollTo(0,0);
            }
        } catch (e) { }
    }

    function setupGame(start, target) {
        targetTitle = target;
        clicks = 0; seconds = 0; historyStack = [];
        document.getElementById('target-label').innerText = target;
        document.getElementById('start-screen').style.display = 'none';
        startTimer();
        loadArticle(start);
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            seconds++;
            const m = Math.floor(seconds/60).toString().padStart(2,'0');
            const s = (seconds%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    async function win() {
        clearInterval(timerInterval);
        if (isDailyChallenge) {
            const todayStr = new Date().toLocaleDateString('en-GB');
            await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: "submitScore",
                    name: playerName,
                    steps: clicks,
                    time: document.getElementById('timer').innerText,
                    target: targetTitle,
                    date: todayStr,
                    path: historyStack.join(" â” ")
                })
            });
        }
        document.getElementById('win-summary').innerText = `×”×’×¢×ª ×œ×™×¢×“ ×‘-${clicks} ×¦×¢×“×™×!`;
        document.getElementById('win-screen').style.display = 'flex';
    }

    async function getRandomArticle() {
        const res = await fetch(`https://www.hamichlol.org.il/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*`);
        const data = await res.json();
        return data.query.random[0].title;
    }

    document.addEventListener('click', e => {
        const link = e.target.closest('#content-area a');
        if (link) {
            e.preventDefault();
            let title = link.title || decodeURIComponent((link.getAttribute('href') || "").replace('/wiki/', ''));
            if (title && !title.includes(':')) {
                clicks++;
                document.getElementById('click-count').innerText = clicks;
                loadArticle(title);
            }
        }
    });

    window.onload = fetchLeaderboard;
</script>
</body>
</html>
